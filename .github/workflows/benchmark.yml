name: Benchmark

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-tools redis-server
          cargo install rust-script

      - name: Run Redis Benchmark
        run: |
          # Start Redis Server
          sudo systemctl start redis-server
          sleep 5
          
          echo "Warmup on Redis..."
          redis-benchmark -q -t set,get -n 1000 -c 10 > /dev/null 2>&1 || true

          echo "Running Benchmark on Redis..."
          # Save to root workspace dir (which is parent of main_branch/pr_branch later)
          redis-benchmark -q -t set,get,hset,hget,lpush,lpop,sadd,srem,zadd,zrem -n 100000 -c 100 -r 100000 -d 512 > benchmark_redis.txt || true
          
          sudo systemctl stop redis-server

      - name: Run Redis Benchmark with Pipeline
        run: |
          # Start Redis Server
          sudo systemctl start redis-server
          sleep 5
          
          echo "Warmup on Redis (Pipeline)..."
          redis-benchmark -q -t set,get -n 1000 -c 10 -P 50 > /dev/null 2>&1 || true

          echo "Running Benchmark on Redis (Pipeline)..."
          redis-benchmark -q -t set,get,hset,hget,lpush,lpop,sadd,srem,zadd,zrem -n 100000 -c 100 -r 100000 -d 512 -P 50 > benchmark_redis_pipeline.txt || true
          
          sudo systemctl stop redis-server

      - name: Checkout Main
        uses: actions/checkout@v6
        with:
          ref: main
          path: main_branch

      - name: Checkout PR Branch
        uses: actions/checkout@v6
        with:
          path: pr_branch

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            main_branch -> target
            pr_branch -> target
          shared-key: benchmark

      - name: Build and Run Main
        working-directory: main_branch
        run: |
          cargo build --release
          ./target/release/nimbis &
          NIMBIS_PID=$!
          echo "Nimbis (Main) started with PID $NIMBIS_PID"
          sleep 10 # Wait for server start
          
          echo "Warmup on Main..."
          redis-benchmark -q -t set,get -n 1000 -c 10 > /dev/null 2>&1 || true

          echo "Running Benchmark on Main..."
          redis-benchmark -q -t set,get,hset,hget,lpush,lpop,sadd,srem,zadd,zrem -n 100000 -c 100 -r 100000 -d 512 > ../benchmark_main.txt || true
          
          kill $NIMBIS_PID

      - name: Build and Run Main with Pipeline
        working-directory: main_branch
        run: |
          ./target/release/nimbis &
          NIMBIS_PID=$!
          echo "Nimbis (Main) started with PID $NIMBIS_PID"
          sleep 10 # Wait for server start
          
          echo "Warmup on Main (Pipeline)..."
          redis-benchmark -q -t set,get -n 1000 -c 10 -P 50 > /dev/null 2>&1 || true

          echo "Running Benchmark on Main (Pipeline)..."
          redis-benchmark -q -t set,get,hset,hget,lpush,lpop,sadd,srem,zadd,zrem -n 100000 -c 100 -r 100000 -d 512 -P 50 > ../benchmark_main_pipeline.txt || true
          
          kill $NIMBIS_PID

      - name: Build and Run PR
        working-directory: pr_branch
        run: |
          cargo build --release
          ./target/release/nimbis &
          NIMBIS_PID=$!
          echo "Nimbis (PR) started with PID $NIMBIS_PID"
          sleep 10 # Wait for server start
          
          echo "Warmup on PR..."
          redis-benchmark -q -t set,get -n 1000 -c 10 > /dev/null 2>&1 || true

          echo "Running Benchmark on PR..."
          redis-benchmark -q -t set,get,hset,hget,lpush,lpop,sadd,srem,zadd,zrem -n 100000 -c 100 -r 100000 -d 512 > ../benchmark_pr.txt || true
          
          kill $NIMBIS_PID

      - name: Build and Run PR with Pipeline
        working-directory: pr_branch
        run: |
          ./target/release/nimbis &
          NIMBIS_PID=$!
          echo "Nimbis (PR) started with PID $NIMBIS_PID"
          sleep 10 # Wait for server start
          
          echo "Warmup on PR (Pipeline)..."
          redis-benchmark -q -t set,get -n 1000 -c 10 -P 50 > /dev/null 2>&1 || true

          echo "Running Benchmark on PR (Pipeline)..."
          redis-benchmark -q -t set,get,hset,hget,lpush,lpop,sadd,srem,zadd,zrem -n 100000 -c 100 -r 100000 -d 512 -P 50 > ../benchmark_pr_pipeline.txt || true
          
          kill $NIMBIS_PID

      - name: Compare Results
        id: compare
        working-directory: pr_branch
        run: |
          # The script is in pr_branch/scripts/compare_benchmarks.rs
          # benchmark files are in ../ (root of workspace)
          
          # output to a file to handle newlines easily in github-script or step output
          rust-script scripts/compare_benchmarks.rs ../benchmark_main.txt ../benchmark_pr.txt ../benchmark_redis.txt ../benchmark_main_pipeline.txt ../benchmark_pr_pipeline.txt ../benchmark_redis_pipeline.txt > ../benchmark_report.md
          
          cat ../benchmark_report.md

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('benchmark_report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            })
